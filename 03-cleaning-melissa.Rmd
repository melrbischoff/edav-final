# Data transformation

# get data frames from sheets
```{r}
library(tidyverse)
library(base)
library(zoo)
library(lubridate)

# from resources.xlsx
ev_charging_use_data = resources_sheets$`Charging Use`

# use clean_rebate_data instead - more up to date but same thing
# ev_rebate_data = resources_sheets$`Drive Clean Rebate`

# from EV-Registration-Tables.xlsx
ev_zip_code_data = ev_registration_tables_sheets$`Current by ZIP Code`
ev_make_model_data = ev_registration_tables_sheets$`Current by Make-Model`
ev_county_data = ev_registration_tables_sheets$`Current by County`
ev_over_time_data = ev_registration_tables_sheets$`Original Over Time`
ev_make_over_time = ev_registration_tables_sheets$`Original by Make`

cleanCols <- function(x){
  lower_names = tolower(names(x))
  sub_periods = gsub("\\.", "_", lower_names)
  sub_spaces = gsub(" ","_",sub_periods)
  clean_df_cols = gsub("__","_",sub_spaces)
  return(clean_df_cols)
}

names(global_electric_car_sales_data) = cleanCols(global_electric_car_sales_data)
names(energy_programs_data) = cleanCols(energy_programs_data)
names(emissions_from_fuel_data) = cleanCols(emissions_from_fuel_data)
names(fuel_emission_factors_data) = cleanCols(fuel_emission_factors_data)
names(clean_rebate_data) = cleanCols(clean_rebate_data)
names(ev_registrations_data) = cleanCols(ev_registrations_data)

# ev_original_registrations_data = filter(ev_registrations_data, registration == 'Original')

clean_rebate_data$date = as.Date(clean_rebate_data$submitted_date, "%m/%d/%Y")
clean_rebate_data$year = format(clean_rebate_data$date, format="%Y")
clean_rebate_data$year_quarter <- as.yearqtr(clean_rebate_data$date, format = "%Y-%m-%d")

clean_rebate_data$cumulative_rebate_amount = cumsum(clean_rebate_data$rebate_amount_usd_)

# count by quarter
clean_rebate_counts = clean_rebate_data %>% group_by(year_quarter) %>% tally()

# by quarter
clean_rebate_data_by_quarter = aggregate(clean_rebate_data$rebate_amount_usd_,
                                         by=list(clean_rebate_data$year_quarter),
                                         FUN=sum)

names(clean_rebate_data_by_quarter) = c("year_quarter", "rebate_amount")

clean_rebate_data_by_quarter$cumulative_rebate_amount = cumsum(clean_rebate_data_by_quarter$rebate_amount)
clean_rebate_data_by_quarter$count = clean_rebate_counts$n
clean_rebate_data_by_quarter$cumulative_count = cumsum(clean_rebate_data_by_quarter$count)
```

